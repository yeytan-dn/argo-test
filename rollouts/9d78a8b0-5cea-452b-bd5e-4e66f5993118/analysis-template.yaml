apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  annotations:
    rollout-manager/devices: a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d
    rollout-manager/templates: cf74ebb4-bddf-49f4-9e2a-3b55a3574176
  labels:
    app: example-rollout
    rollout-id: 9d78a8b0-5cea-452b-bd5e-4e66f5993118
    rollout-manager: "true"
  name: rollout-analysis-9d78a8b0-5cea-452b-bd5e-4e66f5993118
  namespace: argo-rollouts
spec:
  args:
  - name: rollout-percentage
  - name: device-subset
  metrics:
  - count: 1
    failureCondition: result[0] == "failure"
    failureLimit: 0
    name: cms-config-apply
    provider:
      job:
        spec:
          backoffLimit: 2
          template:
            spec:
              containers:
              - args:
                - /bin/sh
                - -c
                - |2

                  HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/response.txt \
                    -X POST "$CMS_BASE_URL$CMS_CONFIG_ROLLOUT_PATH" \
                    -H "Content-Type: application/json" \
                    -d @- <<EOF
                  {
                    "deviceIds": $DEVICES_JSON,
                    "rolloutName": "$ROLLOUT_ID",
                    "templateIds": $TEMPLATES_JSON
                  }
                  EOF
                  )

                  if [ "$HTTP_CODE" = "201" ]; then
                    echo "success"
                    exit 0
                  else
                    echo "failure: HTTP $HTTP_CODE"
                    cat /tmp/response.txt 2>/dev/null
                    exit 1
                  fi
                env:
                - name: ROLLOUT_ID
                  value: 9d78a8b0-5cea-452b-bd5e-4e66f5993118
                - name: ROLLOUT_NAME
                  value: example-rollout
                - name: CMS_BASE_URL
                  value: http://config-manager:3100
                - name: CMS_CONFIG_ROLLOUT_PATH
                  value: /api/configurations/devices/config-rollout
                - name: TEMPLATES_JSON
                  value: '["cf74ebb4-bddf-49f4-9e2a-3b55a3574176"]'
                - name: DEVICES_JSON
                  value: '{{args.device-subset}}'
                - name: ROLLOUT_PERCENTAGE
                  value: '{{args.rollout-percentage}}'
                - name: CMS_BASE_URL
                  value: http://config-manager:3100
                image: nginx:1.25-alpine
                name: cms-config-applier
              restartPolicy: Never
    successCondition: result[0] == "success"
  - count: 120
    initialDelay: 30s
    interval: 30s
    name: device-success-rate
    provider:
      web:
        jsonPath: '{$.data.successPercent}'
        url: http://rollout-manager-service.rollout-manager.svc.cluster.local:8080/api/v1/rollouts/9d78a8b0-5cea-452b-bd5e-4e66f5993118/metrics
    successCondition: result == 1
